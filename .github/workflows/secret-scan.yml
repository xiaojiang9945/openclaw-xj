name: secret-scan

on:
  pull_request:
  push:
    branches: ["main", "master"]

jobs:
  scan:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run staged-like secret scan on repo content
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $patterns = @(
            'AKIA[0-9A-Z]{16}',
            'AIza[0-9A-Za-z\-_]{35}',
            'ghp_[A-Za-z0-9]{36,}',
            'github_pat_[A-Za-z0-9_]{20,}',
            'xox[baprs]-[A-Za-z0-9\-]{10,}',
            '-----BEGIN (RSA|EC|DSA|OPENSSH|PRIVATE) KEY-----',
            '(?i)authorization\s*:\s*(bearer|basic)\s+[A-Za-z0-9\-\._~\+/=]{20,}'
          )
          $files = Get-ChildItem -Recurse -File | Where-Object {
            $_.FullName -notmatch '\\.git\\' -and $_.Length -lt 2MB
          }
          $hits = @()
          foreach ($f in $files) {
            $text = Get-Content -Raw -ErrorAction SilentlyContinue $f.FullName
            if (-not $text) { continue }
            foreach ($p in $patterns) {
              if ($text -match $p) {
                $hits += "${($f.FullName)} :: pattern=${p}"
              }
            }
          }
          if ($hits.Count -gt 0) {
            Write-Host '[BLOCKED] potential secret patterns found:' -ForegroundColor Red
            $hits | Select-Object -Unique | ForEach-Object { Write-Host " - $_" }
            exit 1
          }
          Write-Host 'secret-scan pass'
